(function(){var e;e=angular.module("skinnyBlog",["ngCookies","ui.router"]).config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$locationProvider","$provide",function(e,t,r,n,i){return n.html5Mode(!0),r.strictMode(!1),e.state("articles",{url:"^/",templateUrl:"partials/articles.html",controller:"ArticlesController as articles"}).state("articles/page",{url:"^/page/{page:[1-9][0-9]*}",templateUrl:"partials/articles.html",controller:"ArticlesController as articles"}).state("tag",{url:"^/tag/:tag",templateUrl:"partials/tag.html",controller:"ArticlesController as articles"}).state("tag/page",{url:"^/tag/:tag/page/{page:[1-9][0-9]*}",templateUrl:"partials/tag.html",controller:"ArticlesController as articles"}).state("article",{url:"^/{year:[0-9]{4}}/{month:[0-9]{2}}/:title",templateUrl:"partials/article.html",controller:"ArticleController as article"}).state("admin",{url:"^/admin",templateUrl:"partials/admin/dashboard.html",controller:"AdminDashboardController as dashboard",options:{secure:!0}}).state("admin/article",{url:"^/admin/articles/{id:[0-9]+}",templateUrl:"partials/admin/article.html",controller:"AdminArticleController as admin",options:{secure:!0}}).state("admin/article/new",{url:"^/admin/articles/new",templateUrl:"partials/admin/article.html",controller:"AdminArticleController as admin",options:{secure:!0}}).state("admin/login",{url:"^/admin/login",templateUrl:"partials/admin/login.html",controller:"AdminLoginController as login"}),i.decorator("$q",["$delegate",function(e){var t;return t=e.defer,e.defer=function(){var e;return e=t(),e.promise.success=function(t){return e.promise.then(t),e.promise},e.promise.error=function(t){return e.promise.then(null,t),e.promise},e},e}])}]),e.run(["$rootScope","$state","ActivityService","AuthService",function(e,t,r,n){return r.decrementCounter(),e.$on("$stateChangeStart",function(e,r,i){return n.isAuthenticated&&"admin/login"===r.name?(e.preventDefault(),t.go("admin")):!n.isAuthenticated&&r.options&&r.options.secure?(e.preventDefault(),n.desiredState={state:r.name,params:i},t.go("admin/login")):void 0})}])}).call(this),function(){angular.module("skinnyBlog").controller("AdminLoginController",["$state","AuthService","ActivityService","AlertService",function(e,t,r,n){var i;return new(i=function(){function i(){this.signingIn=!1}return i.prototype.attempt=function(){var i;return this.signingIn=!0,i=t.signIn(),r.addPromise(i),i.success(function(r){return function(){return r.signingIn=!1,t.desiredState?e.go(t.desiredState.state,t.desiredState.params):e.go("admin")}}(this)).error(function(e){return function(t){return e.signingIn=!1,n.add("Error: "+t)}}(this))},i}())}])}.call(this),function(){angular.module("skinnyBlog").controller("ArticleController",["$stateParams","ApiService","ActivityService",function(e,t,r){var n;return new(n=function(){function n(){var n;n=t.getArticle(e.year,e.month,e.title),r.addPromise(n),n.success(function(e){return function(t){return e.putArticleInScope(t.article)}}(this)).error(function(e){return console.log(e)})}return n.prototype.putArticleInScope=function(e){var t,r,n,i,a;for(t=["title","text","publishedDate","slugParts","tags"],a=[],n=0,i=t.length;i>n;n++)r=t[n],a.push(this[r]=e[r]);return a},n}())}])}.call(this),function(){angular.module("skinnyBlog").controller("ArticlesController",["$state","ApiService","ActivityService",function(e,t,r){var n;return new(n=function(){function n(){var n,i;this.prevHref=null,this.nextHref=null,this.all=null,this.pages=null,n=e.params,this.page=n.page&&n.page>=1?parseInt(n.page):1,this.nextPage=this.page,this.previousPage=this.page,this.tag=n.tag?(this.rawTag=n.tag,n.tag.replace(/-/g," ")):null,i=t.getArticles(this.page,this.tag),r.addPromise(i),i.success(function(t){return function(r){var i;if(t.all=r.articles,r.meta.pages&&r.meta.pages>1){if(t.pages=r.meta.pages,i=t.tag?"tag":"articles",n=t.tag?{tag:t.rawTag}:{},t.page<t.pages&&(t.prevHref=e.href(i+"/page",$.extend({},n,{page:t.page+1}))),2===t.page)return t.nextHref=e.href(i,n);if(t.page>2)return t.nextHref=e.href(i+"/page",$.extend({},n,{page:t.page-1}))}}}(this)).error(function(e){return function(){return e.all=!1}}(this))}return n.prototype.closeTagSearch=function(){return this.tag?e.go("articles"):void 0},n}())}])}.call(this),function(){angular.module("skinnyBlog").factory("ActivityService",function(){var e;return new(e=function(){function e(){this.element=$("#activity-spinner"),this.counter=1}return e.prototype.decrementCounter=function(){return this.counter--,this.counter<0&&(this.counter=0),0===this.counter?this.element.finish().fadeOut():void 0},e.prototype.incrementCounter=function(){return this.counter++,this.counter>0?this.element.finish().fadeIn():void 0},e.prototype.addPromise=function(e){var t;return this.incrementCounter(),t=function(e){return function(){return e.decrementCounter()}}(this),e.then(t,t)},e}())})}.call(this),function(){var e;e=angular.module("skinnyBlog"),e.directive("bhArticle",function(){return{restrict:"E",templateUrl:"partials/article.html",scope:{article:"=bhModel"}}}),e.directive("bhMarkdown",function(){return{restrict:"A",scope:{markdown:"&bhMarkdown"},link:function(e,t){return require(["marked","highlight"],function(r,n){var i;return r.setOptions({langPrefix:"hljs ",highlight:function(e){return n.highlightAuto(e).value}}),i=function(){return e.markdown()?t.html(r(e.markdown())):void 0},i(),e.$watch(e.markdown,i)})}}}),e.directive("bhPickadate",function(){return{restrict:"A",scope:{date:"=bhPickadate",updateFn:"&bhPickadateChange"},link:function(e,t){return require(["picker","picker.date"],function(){var r,n,i;return r=$(t),r.pickadate({format:"d mmmm yyyy",onSet:function(t){var r;return r=t.select,r instanceof Date?void 0:e.date.setTime(r)}}),n=r.pickadate("picker"),i=function(e){return e?n.set("select",e):void 0},i(e.date),e.$watch("date",i)})}}}),e.directive("bhEditor",["AuthService","ActivityService","AlertService",function(e,t,r){return{restrict:"A",scope:{theme:"@bhEditorTheme",language:"@bhEditorLanguage",update:"&bhEditorUpdate",model:"=bhEditorModel"},link:function(n,i){return require(["ace","dropzone"],function(){var a,o,l,c;return c=n.theme?n.theme:"monokai",o=n.language?n.language:"markdown",a=ace.edit(i[0]),a.setTheme("ace/theme/"+c),a.getSession().setMode("ace/mode/"+o),a.getSession().setUseSoftTabs(!0),n.model&&a.setValue(n.model),n.$watch("model",function(){return!a.getValue()&&n.model?a.setValue(n.model):void 0}),a.getSession().on("change",function(){return n.update()(a.getValue())}),l="![Uploading...]()",$(i).dropzone({url:"/api/images",headers:{"X-OAuth-Token":e.token},acceptedFiles:"image/*",drop:function(){return a.insert(l),t.incrementCounter()},success:function(e,t){return a.find(l),a.replace("!["+e.name+"]("+t.image+")")},error:function(){return a.find(l),a.replace(""),r.add("There was an error uploading the image.")},complete:function(){return t.decrementCounter()}})})}}}]),e.directive("bhAlerts",["$timeout",function(e){return{restrict:"E",template:'<div class="alert" role="alert" ng-repeat="alert in alerts" ng-class="\'alert-\' + alert.type">\n    <button type="button" class="close" aria-label="Close" ng-click="close($index)">\n        <span aria-hidden="true">&times;</span>\n    </button>\n    {{ alert.message }}\n</div>',scope:{},link:function(t){return t.alerts=[],t.$on("newAlert",function(r,n){return e(function(){return t.alerts.push(n)})}),t.close=function(e){return t.alerts.splice(e,1)}}}}]),e.directive("bhPagination",function(){return{restrict:"E",replace:!0,template:'<nav>\n    <ul class="pager">\n        <li class="previous">\n            <a ng-href="{{ previousHref }}" ng-show="!previousDisabled">\n                <span aria-hidden="true">&larr;</span> Older\n            </a>\n        </li>\n        <li class="next">\n            <a ng-href="{{ nextHref }}" ng-show="!nextDisabled">\n                Newer <span aria-hidden="true">&rarr;</span>\n            </a>\n        </li>\n    </ul>\n</nav>',scope:{previousDisabled:"=",previousHref:"=",nextDisabled:"=",nextHref:"="}}})}.call(this),function(){angular.module("skinnyBlog").factory("ApiService",["$http","$cacheFactory","$q",function(e,t,r){var n;return new(n=function(){function n(){this.cache=t("apiServiceCache")}return n.prototype.getArticles=function(t,n){return null==t&&(t=1),null==n&&(n=null),this.cacheOrPerform("articles "+t+" "+n,function(i){return function(){var a,o;return a=r.defer(),o="/api/articles?page="+t,null!==n&&(o+="&tag="+n),e.get(o).success(function(e){return i.cacheArticles(e.articles),a.resolve(e)}).error(function(e){return a.reject(e)}),a.promise}}(this))},n.prototype.getArticle=function(t,r,n){var i;return null==r&&(r=null),null==n&&(n=null),i=null!==r&&null!==n?t+"/"+r+"/"+n:t,this.cacheOrPerform("article:"+i,function(){return e.get("/api/articles/"+i)})},n.prototype.createArticle=function(t,r){return e.post("/api/articles",{article:t},this.authHeaders(r))},n.prototype.saveArticle=function(t,r){return e.put("/api/articles/"+t.id,{article:t},this.authHeaders(r))},n.prototype.cacheArticles=function(e){var t,n,i,a,o;for(o=[],i=0,a=e.length;a>i;i++)t=e[i],n=r.defer(),n.resolve({article:t}),o.push(this.cache.put("article:"+t.slug,n.promise));return o},n.prototype.getAuthInfo=function(){return this.cacheOrPerform("oauth clientId",function(){return e.get("/api/auth/info")})},n.prototype.hasValidAuthentication=function(t){return e.get("/api/auth/check",this.authHeaders(t))},n.prototype.adminGetArticles=function(t){return e.get("/api/articles/all",this.authHeaders(t))},n.prototype.adminDeleteArticle=function(t){return e["delete"]("/api/articles/"+t,this.authHeaders(token))},n.prototype.authHeaders=function(e){return{headers:{"X-OAuth-Token":e}}},n.prototype.cacheOrPerform=function(e,t){var r;return r=this.cache.get(e),void 0===r&&(r=t(),this.cache.put(e,r)),r},n}())}])}.call(this),function(){angular.module("skinnyBlog").factory("AuthService",["$http","$cacheFactory","$window","$q","$cookieStore","ApiService",function(e,t,r,n,i,a){var o;return new(o=function(){function e(){this.token=this.getStoredToken(),this.isAuthenticated=!!this.token,this.desiredState=!1}return e.tokenKey="oauthToken",e.prototype.getStoredToken=function(){var t;return t=i.get(e.tokenKey),t&&new Date(t.expiration).getTime()>(new Date).getTime()?t.token:null},e.prototype.storeToken=function(t,r){return i.put(e.tokenKey,{token:t,expiration:r})},e.prototype.signIn=function(){var e;return e=n.defer(),r.googleOauthCallback=function(t){return function(r){var n;return r.status.signed_in?(t.token=r.access_token,n=new Date(1e3*parseInt(r.expires_at)),a.hasValidAuthentication(t.token).success(function(){return t.isAuthenticated=!0,t.storeToken(t.token,n),e.resolve()}).error(function(){return e.reject("You do not have permission to access this area")})):e.reject("Could not authenticate against Google OAuth")}}(this),a.getAuthInfo().success(function(e){return r.gapi.auth.signIn({clientid:e.clientId,cookiepolicy:"single_host_origin",callback:"googleOauthCallback"})}).error(function(){return e.reject("Could not get OAuth client ID")}),e.promise},e}())}])}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};angular.module("skinnyBlog").controller("AdminArticleController",["$scope","$timeout","$state","$stateParams","ApiService","AuthService","ActivityService","AlertService",function(t,r,n,i,a,o,l,c){var u;return new(u=function(){function t(){this.articleText=e(this.articleText,this);var t;this.saving=!1,this.isSlugDirty=!1,this.article=null,this.pristineArticle=!1,i.id?(t=a.getArticle(i.id),l.addPromise(t),t.success(function(e){return function(t){return e.article=t.article,e.article.publishedDate=new Date(e.article.publishedDate),e.isSlugDirty=e.article.published,e.pristineArticle=angular.copy(e.article)}}(this)).error(function(){return c.add("Alert id:"+i.id+" not found."),n.go("admin")})):(this.article={published:!1,publishedDate:new Date},this.pristineArticle=angular.copy(this.article))}return t.prototype.publish=function(){return this.article.published=!0,this.save(!0)},t.prototype.save=function(e){var t,r;return null==e&&(e=!1),this.saving=!0,t=!this.article.id,r=t?a.createArticle(this.article,o.token):a.saveArticle(this.article,o.token),l.addPromise(r),r.success(function(r){return function(i){return r.saving=!1,t&&(r.article.id=i.article.id),e?(c.add('Article "'+r.article.title+'" saved.',"success"),n.go("admin")):void 0}}(this)).error(function(e){return function(){return e.saving=!1,c.add("Article could not be saved.")}}(this))},t.prototype.updateSlug=function(e){var t;return null==e&&(e=!1),t=function(e){return function(){var t,r,n;return e.article.slug=!e.isSlugDirty&&e.article.title&&e.article.publishedDate&&e.article.publishedDate.getFullYear()?(n=e.article.publishedDate.getFullYear(),t=""+(e.article.publishedDate.getMonth()+1),t="00".substring(0,2-t.length)+t,r=e.article.title.replace(/[^a-z0-9 -]+/gi,"").replace(/\s+/g,"-").toLowerCase(),n+"/"+t+"/"+r):e.article.slug}}(this),e?r(t):t()},t.prototype.articleText=function(e){return null==e&&(e=null),null!==e?r(function(t){return function(){return t.article.text=e}}(this)):e},t}())}])}.call(this),function(){angular.module("skinnyBlog").controller("AdminDashboardController",["ApiService","ActivityService","AuthService","AlertService",function(e,t,r,n){var i;return new(i=function(){function i(){var n;this.articles=null,n=e.adminGetArticles(r.token),t.addPromise(n),n.success(function(e){return function(t){return e.articles=t.articles}}(this)).error(function(e){return function(){return e.articles=!1}}(this))}return i.prototype.deleteArticle=function(t){var i,a;return window.confirm("Are you sure you want to delete this article?")?(i=this.articles[t],a=e.adminDeleteArticle(i.id,r.token),a.success(function(e){return function(){return e.articles.splice(t,1)}}(this)).error(function(){return n.add("Article id:"+i.id+" could not be deleted.")})):void 0},i}())}])}.call(this),function(){angular.module("skinnyBlog").factory("AlertService",["$rootScope",function(e){var t;return new(t=function(){function t(){window.aleets=this}return t.prototype.add=function(t,r){return null==r&&(r="danger"),e.$broadcast("newAlert",{message:t,type:r})},t}())}])}.call(this);
//# sourceMappingURL=app.min.js.map