(function(){var t;t=angular.module("skinnyBlog",["ngCookies","ui.router"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$provide",function(t,e,r,n){return r.html5Mode(!0),t.state("articles",{url:"^/",templateUrl:"partials/articles.html",controller:"ArticlesController as articles"}).state("tag",{url:"^/tag/:tag",templateUrl:"partials/articles.html",controller:"ArticlesController as articles"}).state("article",{url:"^/{year:[0-9]{4}}/{month:[0-9]{2}}/:title",templateUrl:"partials/article.html",controller:"ArticleController as article"}).state("admin",{url:"^/admin",templateUrl:"partials/admin/dashboard.html",controller:"AdminDashboardController as dashboard",options:{secure:!0}}).state("admin/article",{url:"^/admin/articles/{id:[0-9]+}",templateUrl:"partials/admin/article.html",controller:"AdminArticleController as admin",options:{secure:!0}}).state("admin/article/new",{url:"^/admin/articles/new",templateUrl:"partials/admin/article.html",controller:"AdminArticleController as admin",options:{secure:!0}}).state("admin/login",{url:"^/admin/login",templateUrl:"partials/admin/login.html",controller:"AdminLoginController as login"}),n.decorator("$q",["$delegate",function(t){var e;return e=t.defer,t.defer=function(){var t;return t=e(),t.promise.success=function(e){return t.promise.then(e),t.promise},t.promise.error=function(e){return t.promise.then(null,e),t.promise},t},t}])}]),t.run(["$rootScope","$state","ActivityService","AuthService",function(t,e,r,n){return r.decrementCounter(),t.$on("$stateChangeStart",function(t,r,i){return n.isAuthenticated&&"admin/login"===r.name?(t.preventDefault(),e.go("admin")):!n.isAuthenticated&&r.options&&r.options.secure?(t.preventDefault(),n.desiredState={state:r.name,params:i},e.go("admin/login")):void 0})}])}).call(this),function(){angular.module("skinnyBlog").controller("AdminLoginController",["$state","AuthService","ActivityService","AlertService",function(t,e,r,n){var i;return new(i=function(){function i(){this.signingIn=!1}return i.prototype.attempt=function(){var i;return this.signingIn=!0,i=e.signIn(),r.addPromise(i),i.success(function(r){return function(){return r.signingIn=!1,e.desiredState?t.go(e.desiredState.state,e.desiredState.params):t.go("admin")}}(this)).error(function(t){return function(e){return t.signingIn=!1,n.add("Error: "+e)}}(this))},i}())}])}.call(this),function(){angular.module("skinnyBlog").controller("ArticleController",["$stateParams","ApiService","ActivityService",function(t,e,r){var n;return new(n=function(){function n(){var n;n=e.getArticle(t.year,t.month,t.title),r.addPromise(n),n.success(function(t){return function(e){return t.putArticleInScope(e.article)}}(this)).error(function(t){return console.log(t)})}return n.prototype.putArticleInScope=function(t){var e,r,n,i,o;for(e=["title","text","publishedDate","slugParts","tags"],o=[],n=0,i=e.length;i>n;n++)r=e[n],o.push(this[r]=t[r]);return o},n}())}])}.call(this),function(){angular.module("skinnyBlog").controller("ArticlesController",["$stateParams","ApiService","ActivityService",function(t,e,r){var n;return new(n=function(){function n(){var n;this.all=null,n=t.tag?(this.rawTag=t.tag,this.tag=t.tag.replace(/-/g," "),e.getArticlesWithTag(t.tag)):e.getArticles(),r.addPromise(n),n.success(function(t){return function(e){return t.all=e.articles}}(this)).error(function(t){return function(){return t.all=!1}}(this))}return n}())}])}.call(this),function(){angular.module("skinnyBlog").factory("ActivityService",function(){var t;return new(t=function(){function t(){this.element=$("#activity-spinner"),this.counter=1}return t.prototype.decrementCounter=function(){return this.counter--,this.counter<0&&(this.counter=0),0===this.counter?this.element.finish().fadeOut():void 0},t.prototype.incrementCounter=function(){return this.counter++,this.counter>0?this.element.finish().fadeIn():void 0},t.prototype.addPromise=function(t){var e;return this.incrementCounter(),e=function(t){return function(){return t.decrementCounter()}}(this),t.then(e,e)},t}())})}.call(this),function(){var t;t=angular.module("skinnyBlog"),t.directive("bhArticle",function(){return{restrict:"E",templateUrl:"partials/article.html",scope:{article:"=bhModel"}}}),t.directive("bhMarkdown",function(){return{restrict:"A",scope:{markdown:"&bhMarkdown"},link:function(t,e){return require(["marked","highlight"],function(r,n){var i;return r.setOptions({langPrefix:"hljs ",highlight:function(t){return n.highlightAuto(t).value}}),i=function(){return t.markdown()?e.html(r(t.markdown())):void 0},i(),t.$watch(t.markdown,i)})}}}),t.directive("bhPickadate",function(){return{restrict:"A",scope:{date:"=bhPickadate",updateFn:"&bhPickadateChange"},link:function(t,e){return require(["picker","picker.date"],function(){var r,n,i;return r=$(e),r.pickadate({format:"d mmmm yyyy",onSet:function(e){var r;return r=e.select,r instanceof Date?void 0:t.date.setTime(r)}}),n=r.pickadate("picker"),i=function(t){return t?n.set("select",t):void 0},i(t.date),t.$watch("date",i)})}}}),t.directive("bhEditor",["AuthService","ActivityService","AlertService",function(t,e,r){return{restrict:"A",scope:{theme:"@bhEditorTheme",language:"@bhEditorLanguage",update:"&bhEditorUpdate",model:"=bhEditorModel"},link:function(n,i){return require(["ace","dropzone"],function(){var o,a,c,u;return u=n.theme?n.theme:"monokai",a=n.language?n.language:"markdown",o=ace.edit(i[0]),o.setTheme("ace/theme/"+u),o.getSession().setMode("ace/mode/"+a),o.getSession().setUseSoftTabs(!0),n.model&&o.setValue(n.model),n.$watch("model",function(){return!o.getValue()&&n.model?o.setValue(n.model):void 0}),o.getSession().on("change",function(){return n.update()(o.getValue())}),c="![Uploading...]()",$(i).dropzone({url:"/api/images",headers:{"X-OAuth-Token":t.token},acceptedFiles:"image/*",drop:function(){return o.insert(c),e.incrementCounter()},success:function(t,e){return o.find(c),o.replace("!["+t.name+"]("+e.image+")")},error:function(){return o.find(c),o.replace(""),r.add("There was an error uploading the image.")},complete:function(){return e.decrementCounter()}})})}}}]),t.directive("bhAlerts",["$timeout",function(t){return{restrict:"E",template:'<div class="alert" role="alert" ng-repeat="alert in alerts" ng-class="\'alert-\' + alert.type">\n    <button type="button" class="close" aria-label="Close" ng-click="close($index)">\n        <span aria-hidden="true">&times;</span>\n    </button>\n    {{ alert.message }}\n</div>',scope:{},link:function(e){return e.alerts=[],e.$on("newAlert",function(r,n){return t(function(){return e.alerts.push(n)})}),e.close=function(t){return e.alerts.splice(t,1)}}}}])}.call(this),function(){angular.module("skinnyBlog").factory("ApiService",["$http","$cacheFactory","$q",function(t,e,r){var n;return new(n=function(){function n(){this.cache=e("apiServiceCache")}return n.prototype.getArticles=function(){return this.cacheOrPerform("articles",function(e){return function(){var n;return n=r.defer(),t.get("/api/articles").success(function(t){return e.cacheArticles(t.articles),n.resolve(t)}).error(function(t){return n.reject(t)}),n.promise}}(this))},n.prototype.getArticlesWithTag=function(e){return this.cacheOrPerform("articles tag:"+e,function(n){return function(){var i;return i=r.defer(),t.get("/api/articles?tag="+e).success(function(t){return n.cacheArticles(t.articles),i.resolve(t)}).error(function(t){return i.reject(t)}),i.promise}}(this))},n.prototype.getArticle=function(e,r,n){var i;return null==r&&(r=null),null==n&&(n=null),i=null!==r&&null!==n?e+"/"+r+"/"+n:e,this.cacheOrPerform("article:"+i,function(){return t.get("/api/articles/"+i)})},n.prototype.createArticle=function(e,r){return t.post("/api/articles",{article:e},this.authHeaders(r))},n.prototype.saveArticle=function(e,r){return t.put("/api/articles/"+e.id,{article:e},this.authHeaders(r))},n.prototype.cacheArticles=function(t){var e,n,i,o,a;for(a=[],i=0,o=t.length;o>i;i++)e=t[i],n=r.defer(),n.resolve({article:e}),a.push(this.cache.put("article:"+e.slug,n.promise));return a},n.prototype.getAuthInfo=function(){return this.cacheOrPerform("oauth clientId",function(){return t.get("/api/auth/info")})},n.prototype.hasValidAuthentication=function(e){return t.get("/api/auth/check",this.authHeaders(e))},n.prototype.adminGetArticles=function(e){return t.get("/api/articles/all",this.authHeaders(e))},n.prototype.adminDeleteArticle=function(e){return t["delete"]("/api/articles/"+e,this.authHeaders(token))},n.prototype.authHeaders=function(t){return{headers:{"X-OAuth-Token":t}}},n.prototype.cacheOrPerform=function(t,e){var r;return r=this.cache.get(t),void 0===r&&(r=e(),this.cache.put(t,r)),r},n}())}])}.call(this),function(){angular.module("skinnyBlog").factory("AuthService",["$http","$cacheFactory","$window","$q","$cookieStore","ApiService",function(t,e,r,n,i,o){var a;return new(a=function(){function t(){this.token=this.getStoredToken(),this.isAuthenticated=!!this.token,this.desiredState=!1}return t.tokenKey="oauthToken",t.prototype.getStoredToken=function(){var e;return e=i.get(t.tokenKey),e&&new Date(e.expiration).getTime()>(new Date).getTime()?e.token:null},t.prototype.storeToken=function(e,r){return i.put(t.tokenKey,{token:e,expiration:r})},t.prototype.signIn=function(){var t;return t=n.defer(),r.googleOauthCallback=function(e){return function(r){var n;return r.status.signed_in?(e.token=r.access_token,n=new Date(1e3*parseInt(r.expires_at)),o.hasValidAuthentication(e.token).success(function(){return e.isAuthenticated=!0,e.storeToken(e.token,n),t.resolve()}).error(function(){return t.reject("You do not have permission to access this area")})):t.reject("Could not authenticate against Google OAuth")}}(this),o.getAuthInfo().success(function(t){return r.gapi.auth.signIn({clientid:t.clientId,cookiepolicy:"single_host_origin",callback:"googleOauthCallback"})}).error(function(){return t.reject("Could not get OAuth client ID")}),t.promise},t}())}])}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("skinnyBlog").controller("AdminArticleController",["$scope","$timeout","$state","$stateParams","ApiService","AuthService","ActivityService","AlertService",function(e,r,n,i,o,a,c,u){var l;return new(l=function(){function e(){this.articleText=t(this.articleText,this);var e;this.saving=!1,this.isSlugDirty=!1,this.article=null,this.pristineArticle=!1,i.id?(e=o.getArticle(i.id),c.addPromise(e),e.success(function(t){return function(e){return t.article=e.article,t.article.publishedDate=new Date(t.article.publishedDate),t.isSlugDirty=t.article.published,t.pristineArticle=angular.copy(t.article)}}(this)).error(function(){return u.add("Alert id:"+i.id+" not found."),n.go("admin")})):(this.article={published:!1,publishedDate:new Date},this.pristineArticle=angular.copy(this.article))}return e.prototype.publish=function(){return this.article.published=!0,this.save(!0)},e.prototype.save=function(t){var e,r;return null==t&&(t=!1),this.saving=!0,e=!this.article.id,r=e?o.createArticle(this.article,a.token):o.saveArticle(this.article,a.token),c.addPromise(r),r.success(function(r){return function(i){return r.saving=!1,e&&(r.article.id=i.article.id),t?(u.add('Article "'+r.article.title+'" saved.',"success"),n.go("admin")):void 0}}(this)).error(function(t){return function(){return t.saving=!1,u.add("Article could not be saved.")}}(this))},e.prototype.updateSlug=function(t){var e;return null==t&&(t=!1),e=function(t){return function(){var e,r,n;return t.article.slug=!t.isSlugDirty&&t.article.title&&t.article.publishedDate&&t.article.publishedDate.getFullYear()?(n=t.article.publishedDate.getFullYear(),e=""+(t.article.publishedDate.getMonth()+1),e="00".substring(0,2-e.length)+e,r=t.article.title.replace(/[^a-z0-9 -]+/gi,"").replace(/\s+/g,"-").toLowerCase(),n+"/"+e+"/"+r):t.article.slug}}(this),t?r(e):e()},e.prototype.articleText=function(t){return null==t&&(t=null),null!==t?r(function(e){return function(){return e.article.text=t}}(this)):t},e}())}])}.call(this),function(){angular.module("skinnyBlog").controller("AdminDashboardController",["ApiService","ActivityService","AuthService","AlertService",function(t,e,r,n){var i;return new(i=function(){function i(){var n;this.articles=null,n=t.adminGetArticles(r.token),e.addPromise(n),n.success(function(t){return function(e){return t.articles=e.articles}}(this)).error(function(t){return function(){return t.articles=!1}}(this))}return i.prototype.deleteArticle=function(e){var i,o;return window.confirm("Are you sure you want to delete this article?")?(i=this.articles[e],o=t.adminDeleteArticle(i.id,r.token),o.success(function(t){return function(){return t.articles.splice(e,1)}}(this)).error(function(){return n.add("Article id:"+i.id+" could not be deleted.")})):void 0},i}())}])}.call(this),function(){angular.module("skinnyBlog").factory("AlertService",["$rootScope",function(t){var e;return new(e=function(){function e(){window.aleets=this}return e.prototype.add=function(e,r){return null==r&&(r="danger"),t.$broadcast("newAlert",{message:e,type:r})},e}())}])}.call(this);
//# sourceMappingURL=app.min.js.map